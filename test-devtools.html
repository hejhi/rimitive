<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lattice DevTools Test</title>
</head>
<body>
  <h1>Lattice DevTools Test</h1>
  <button id="increment">Increment</button>
  <div id="count">0</div>
  
  <script type="module">
    // Import Lattice (assuming it's built)
    import { createContext } from './packages/lattice/dist/index.js';
    import { signalExtension, computedExtension, effectExtension } from './packages/lattice/dist/index.js';
    
    // Create instrumentation that sends messages to DevTools
    const instrumentation = {
      contextId: 'test-context-' + Date.now(),
      contextName: 'Test Context',
      
      emit(event) {
        console.log('[Test] Emitting event:', event.type, event);
        window.postMessage({
          source: 'lattice-devtools',
          type: 'EVENT',
          payload: {
            ...event,
            contextId: this.contextId
          }
        }, '*');
      },
      
      register(resource, type, name) {
        const id = `${type}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        console.log('[Test] Registering resource:', id, type, name);
        
        // Send registration event
        this.emit({
          type: `${type.toUpperCase()}_CREATED`,
          timestamp: Date.now(),
          data: {
            id,
            type,
            name,
            contextId: this.contextId
          }
        });
        
        return { id, resource };
      }
    };
    
    // Announce Lattice is detected
    console.log('[Test] Announcing Lattice');
    window.postMessage({
      source: 'lattice-devtools',
      type: 'LATTICE_DETECTED',
      payload: {
        enabled: true,
        version: '1.0.0'
      }
    }, '*');
    
    // Also send context created event
    window.postMessage({
      source: 'lattice-devtools',
      type: 'EVENT',
      payload: {
        type: 'CONTEXT_CREATED',
        contextId: instrumentation.contextId,
        timestamp: Date.now(),
        data: {
          id: instrumentation.contextId,
          name: instrumentation.contextName
        }
      }
    }, '*');
    
    // Create context with instrumentation
    const ctx = createContext(
      { instrumentation },
      signalExtension,
      computedExtension,
      effectExtension
    );
    
    // Create a signal
    const count = ctx.signal(0, 'count');
    
    // Create a computed
    const doubled = ctx.computed(() => {
      console.log('[Test] Computing doubled');
      return count.value * 2;
    }, 'doubled');
    
    // Create an effect
    ctx.effect(() => {
      console.log('[Test] Effect running, count:', count.value);
      document.getElementById('count').textContent = count.value;
    });
    
    // Set up increment button
    document.getElementById('increment').addEventListener('click', () => {
      console.log('[Test] Incrementing');
      count.value = count.value + 1;
    });
    
    // Test initial value read
    console.log('[Test] Initial count:', count.value);
    console.log('[Test] Initial doubled:', doubled.value);
  </script>
</body>
</html>