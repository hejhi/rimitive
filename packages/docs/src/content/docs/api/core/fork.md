---
title: "fork() function"
sidebar:
  label: "fork()"
  badge:
    text: "fn"
    variant: "tip"
---

<!-- Do not edit this file. It is automatically generated by API Documenter. -->

[Home](../../) &gt; [@rimitive/core](../) &gt; fork

## fork() function

Create a new composition that shares instances from an existing one, but with fresh instances of specified modules.

Fresh modules are: - Re-instantiated (not shared with the base) - Singleton within the fork (shared by dependents in the forked context) - Disposed when the fork is disposed (base instances are not affected)

Fresh modules can depend on base instances - they receive the base singletons as their dependencies.

**Signature:**

```typescript
export declare function fork<TBase>(base: Use<TBase>, freshModules: AnyModule[], options?: ForkOptions): Use<TBase> | Promise<Use<TBase>>;
```

## Parameters

<table><thead><tr><th>

Parameter


</th><th>

Type


</th><th>

Description


</th></tr></thead>
<tbody><tr><td>

base


</td><td>

[Use](../use/)<!-- -->&lt;TBase&gt;


</td><td>


</td></tr>
<tr><td>

freshModules


</td><td>

[AnyModule](../anymodule/)<!-- -->\[\]


</td><td>


</td></tr>
<tr><td>

options


</td><td>

[ForkOptions](../forkoptions/)


</td><td>

_(Optional)_


</td></tr>
</tbody></table>

**Returns:**

[Use](../use/)<!-- -->&lt;TBase&gt; \| Promise&lt;[Use](../use/)<!-- -->&lt;TBase&gt;&gt;

## Example 1

Basic usage

```ts
const root = compose(ConfigModule, DbPoolModule, DbConnectionModule);

// Create a fork with fresh DbConnection
const scoped = fork(root, [DbConnectionModule]);

scoped.config        // Same instance as root (shared)
scoped.dbPool        // Same instance as root (shared)
scoped.dbConnection  // Fresh instance (not root's)

// Cleanup fresh instances
scoped.dispose();
// root is unaffected
```

## Example 2

Per-request context in a server

```ts
const root = compose(ConfigModule, DbPoolModule);

app.use((req, res, next) => {
  req.svc = fork(root, [DbConnectionModule, RequestContextModule]);
  res.on('finish', () => req.svc.dispose());
  next();
});
```

## Example 3

Test isolation

```ts
const root = compose(AllModules);

beforeEach(() => {
  testSvc = fork(root, [StateModule]); // Fresh state per test
});

afterEach(() => {
  testSvc.dispose();
});
```

## Example 4

Async fresh modules

```ts
const root = await compose(ConfigModule, lazy(DbPoolModule));

// Fork with lazy module returns a Promise
const scoped = await fork(root, [lazy(DbConnectionModule)]);
```

## Example 5

With instrumentation

```ts
const root = compose(ConfigModule, DbPoolModule, { instrumentation });

// Fork can have its own instrumentation for fresh modules
const scoped = fork(root, [DbConnectionModule], { instrumentation: scopedInstr });
```

